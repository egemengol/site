{% extends "base.html" %}

{% block stylesheet %}/blog.css{% endblock stylesheet %}

{% block title %}{{ page.title }}{% endblock title %}

{% block content %}
<article class="blog-post">
    <header class="post-header">
        <h1 class="post-title">{{ page.title }}</h1>

        <div class="post-meta">
            <div class="post-date">
                <span class="material-symbols-outlined">calendar_today</span>
                {{ page.date | date(format="%B %d, %Y") }}
            </div>

            {% if page.taxonomies.series %}
            <div class="post-series">
                <span class="material-symbols-outlined">bookmarks</span>
                Series:
                {% for series in page.taxonomies.series %}
                <a href="{{ get_taxonomy_url(kind="series", name=series) }}">{{ series }}</a>
                {% endfor %}
            </div>
            {% endif %}

            {% if page.word_count %}
            <div class="reading-time">
                <span class="material-symbols-outlined">schedule</span>
                {{ page.word_count / 200 + 1 }} min read
            </div>
            {% endif %}
        </div>

        {% if page.taxonomies.tags %}
        <div class="post-tags">
            {% for tag in page.taxonomies.tags %}
            <a href="{{ get_taxonomy_url(kind="tags", name=tag) }}" class="tag">{{ tag }}</a>
            {% endfor %}
        </div>
        {% endif %}
    </header>

    <div class="post-content">
        {{ page.content | safe }}
    </div>

    {% if page.taxonomies.series %}
        {% for series_name in page.taxonomies.series %}
            {% set series_path = get_taxonomy_url(kind="series", name=series_name) %}
            {% set taxonomy = get_taxonomy(kind="series", term=series_name) %}
            {% if taxonomy and taxonomy.pages %}
                {% set sorted_pages = taxonomy.pages | sort(attribute="date") %}
                
                {% set_global current_index = -1 %}
                {% for series_page in sorted_pages %}
                    {% if series_page.permalink == page.permalink %}
                        {% set_global current_index = loop.index0 %}
                    {% endif %}
                {% endfor %}

                {# Store previous and next pages based on current_index #}
                {% set_global prev_page = none %}
                {% set_global next_page = none %}
                {% if current_index > 0 %}
                    {% for series_page in sorted_pages %}
                        {% if loop.index0 == current_index - 1 %}
                            {% set_global prev_page = series_page %}
                        {% endif %}
                    {% endfor %}
                {% endif %}
                {% if current_index >= 0 and current_index < sorted_pages | length - 1 %}
                    {% for series_page in sorted_pages %}
                        {% if loop.index0 == current_index + 1 %}
                            {% set_global next_page = series_page %}
                        {% endif %}
                    {% endfor %}
                {% endif %}

                <div class="series-navigation">
                    <h3>Posts in the "{{ series_name }}" series</h3>
                    <ol class="series-toc">
                        {% for series_page in sorted_pages %}
                            <li {% if series_page.permalink == page.permalink %}class="current"{% endif %}>
                                <a href="{{ series_page.permalink }}">{{ series_page.title }}</a>
                                {% if series_page.permalink == page.permalink %}(you are here){% endif %}
                            </li>
                        {% endfor %}
                    </ol>
                </div>

                <div class="post-navigation">
                    {% if prev_page %}
                        <a href="{{ prev_page.permalink }}" class="nav-link prev">
                            <span class="nav-label">Previous</span>
                            <span class="nav-title">{{ prev_page.title }}</span>
                        </a>
                    {% else %}
                        <div class="nav-placeholder"></div>
                    {% endif %}

                    <div class="chapter-info">
                        <span>{% if current_index >= 0 %}{{ current_index + 1 }}{% else %}1{% endif %}/{{ sorted_pages | length }}</span>
                    </div>

                    {% if next_page %}
                        <a href="{{ next_page.permalink }}" class="nav-link next">
                            <span class="nav-label">Next</span>
                            <span class="nav-title">{{ next_page.title }}</span>
                        </a>
                    {% else %}
                        <div class="nav-placeholder"></div>
                    {% endif %}
                </div>
            {% else %}
                <div class="series-navigation">
                    <h3>Part of the "{{ series_name }}" series</h3>
                    <p>Visit the <a href="{{ series_path }}">series page</a> to see all posts.</p>
                </div>
            {% endif %}
        {% endfor %}
    {% else %}
        <div class="post-navigation">
            {% if page.earlier %}
                <a href="{{ page.earlier.permalink }}" class="nav-link prev">
                    <span class="nav-label">Previous Post</span>
                    <span class="nav-title">{{ page.earlier.title }}</span>
                </a>
            {% else %}
                <div class="nav-placeholder"></div>
            {% endif %}

            {% if page.later %}
                <a href="{{ page.later.permalink }}" class="nav-link next">
                    <span class="nav-label">Next Post</span>
                    <span class="nav-title">{{ page.later.title }}</span>
                </a>
            {% else %}
                <div class="nav-placeholder"></div>
            {% endif %}
        </div>
    {% endif %}
</article>
{% endblock content %}
